<script defer>
    document.addEventListener('DOMContentLoaded', function() {
      const blogNavigation = document.querySelectorAll('.main-blog__navigation-page');
      const searchForm = document.getElementById('blog-search-form');
      const articlesContainer = document.getElementById('blog-articles-container');
      const paginationContainer = document.getElementById('blog-pagination-container');
      const searchInput = document.getElementById('main-search__input--label');
      
      let currentPage = 1;
      let currentBlog = '{{ blog.handle }}';
      let currentSearchTerm = '';
      let isLoading = false;
      
      // Cache system
      const cache = {
        blog: new Map(), // Cache for blog content
        search: new Map() // Cache for search results
      };
      
      // Cache configuration
      const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
      const MAX_CACHE_SIZE = 50; // Maximum number of cached items per type
    
      // Cache utility functions
      function generateCacheKey(type, identifier, page = 1) {
        return `${type}_${identifier}_${page}`;
      }
    
      function isCacheValid(cacheEntry) {
        return cacheEntry && (Date.now() - cacheEntry.timestamp) < CACHE_DURATION;
      }
    
      function getFromCache(type, key) {
        const cacheEntry = cache[type].get(key);
        if (isCacheValid(cacheEntry)) {
          return cacheEntry.data;
        }
        if (cacheEntry) {
          cache[type].delete(key); // Remove expired entry
        }
        return null;
      }
    
      function setCache(type, key, data) {
        // Remove oldest entries if cache is full
        if (cache[type].size >= MAX_CACHE_SIZE) {
          const firstKey = cache[type].keys().next().value;
          cache[type].delete(firstKey);
        }
        
        cache[type].set(key, {
          data: data,
          timestamp: Date.now()
        });
      }
    
      function clearCache(type = null) {
        if (type) {
          cache[type].clear();
        } else {
          cache.blog.clear();
          cache.search.clear();
        }
      }
    
      // Handle blog navigation clicks
      blogNavigation.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          if (isLoading) return;
          
          const blogUrl = this.getAttribute('data-blog-url');
          // Extract blog handle from URL (e.g., /blogs/news -> news)
          const blogHandle = blogUrl.split('/blogs/')[1] || blogUrl.split('/').pop();
          
          // Update active state
          blogNavigation.forEach(nav => nav.classList.remove('active'));
          this.classList.add('active');
          
          // Reset search
          searchInput.value = '';
          currentSearchTerm = '';
          currentPage = 1;
          currentBlog = blogHandle;
          
          // Update URL without page reload
          const newUrl = `/blogs/${blogHandle}`;
          window.history.pushState({}, '', newUrl);
          
          loadBlogContent();
        });
      });
    
      // Handle search form submission
      searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (isLoading) return;
        
        currentSearchTerm = searchInput.value.trim();
        currentPage = 1;
        
        if (currentSearchTerm) {
          loadSearchContent();
        } else {
          loadBlogContent();
        }
      });
    
      // Handle search input changes (optional: search as you type)
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (isLoading) return;
          
          currentSearchTerm = this.value.trim();
          currentPage = 1;
          
          if (currentSearchTerm) {
            loadSearchContent();
          } else {
            loadBlogContent();
          }
        }, 500); // 500ms delay
      });
    
      function loadBlogContent() {
        if (isLoading) return;
        
        const cacheKey = generateCacheKey('blog', currentBlog, currentPage);
        const cachedData = getFromCache('blog', cacheKey);
        
        if (cachedData) {
          // Use cached data
          articlesContainer.innerHTML = cachedData.articles;
          paginationContainer.innerHTML = cachedData.pagination;
          checkAndShowNoResults(cachedData.articles);
          attachPaginationListeners();
          return;
        }
        
        isLoading = true;
        showLoading();
        
        const url = `/blogs/${currentBlog}?view=ajax&page=${currentPage}`;
        
        fetch(url)
          .then(response => response.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract articles and pagination
            const articles = doc.querySelector('#blog-articles-container');
            const pagination = doc.querySelector('#blog-pagination-container');
            
            const articlesHTML = articles ? articles.innerHTML : '';
            const paginationHTML = pagination ? pagination.innerHTML : '';
            
            // Hide loading spinner before updating content
            hideLoading();
            
            // Update DOM
            articlesContainer.innerHTML = articlesHTML;
            paginationContainer.innerHTML = paginationHTML;
            
            // Check and show no results message if needed
            checkAndShowNoResults(articlesHTML);
            
            // Cache the data
            setCache('blog', cacheKey, {
              articles: articlesHTML,
              pagination: paginationHTML
            });
            
            // Re-attach pagination event listeners
            attachPaginationListeners();
            
            isLoading = false;
          })
          .catch(error => {
            console.error('Error loading blog content:', error);
            hideLoading();
            isLoading = false;
          });
      }
    
      function loadSearchContent() {
        if (isLoading) return;
        
        const cacheKey = generateCacheKey('search', currentSearchTerm, currentPage);
        const cachedData = getFromCache('search', cacheKey);
        
        if (cachedData) {
          // Use cached data
          articlesContainer.innerHTML = cachedData.articles;
          paginationContainer.innerHTML = cachedData.pagination;
          checkAndShowNoResults(cachedData.articles);
          attachPaginationListeners();
          return;
        }
        
        isLoading = true;
        showLoading();
        
        const searchParams = new URLSearchParams({
          q: currentSearchTerm,
          type: 'article',
          'options[prefix]': 'last',
          'sort_by[filter-search-by-blogs]': '',
          page: currentPage
        });
        
        const url = `/search?${searchParams.toString()}&view=ajax`;
        
        fetch(url)
          .then(response => response.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract search results
            const searchResults = doc.querySelector('.search-results') || doc.querySelector('#blog-articles-container');
            const pagination = doc.querySelector('#blog-pagination-container');
            
            const articlesHTML = searchResults ? searchResults.innerHTML : '';
            const paginationHTML = pagination ? pagination.innerHTML : '';
            
            // Hide loading spinner before updating content
            hideLoading();
            
            // Update DOM
            articlesContainer.innerHTML = articlesHTML;
            paginationContainer.innerHTML = paginationHTML;
            
            // Check and show no results message if needed
            checkAndShowNoResults(articlesHTML);
            
            // Cache the data
            setCache('search', cacheKey, {
              articles: articlesHTML,
              pagination: paginationHTML
            });
            
            // Re-attach pagination event listeners
            attachPaginationListeners();
            
            isLoading = false;
          })
          .catch(error => {
            console.error('Error loading search content:', error);
            hideLoading();
            isLoading = false;
          });
      }
    
      function attachPaginationListeners() {
        const paginationLinks = document.querySelectorAll('#blog-pagination-container a');
        paginationLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            const href = this.getAttribute('href');
            const urlParams = new URLSearchParams(href.split('?')[1]);
            const page = urlParams.get('page') || 1;
            
            currentPage = parseInt(page);
            
            if (currentSearchTerm) {
              loadSearchContent();
            } else {
              loadBlogContent();
            }
          });
        });
      }
    
      function showLoading() {
        // Remove existing spinner if any
        const existingSpinner = articlesContainer.querySelector('.loading-spinner');
        if (existingSpinner) {
          existingSpinner.remove();
        }
        
        // Create and prepend loading spinner
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        spinner.innerHTML = `
          <svg class="spinner" viewBox="0 0 50 50">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke="{{ section.settings.loading_spinner_color }}" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416">
              <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
              <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
            </circle>
          </svg>
        `;
        articlesContainer.insertBefore(spinner, articlesContainer.firstChild);
        
        // Add loading class to container to make articles semi-transparent and non-clickable
        articlesContainer.classList.add('loading-active');
        paginationContainer.innerHTML = '';
      }
      
      function hideLoading() {
        // Remove spinner
        const spinner = articlesContainer.querySelector('.loading-spinner');
        if (spinner) {
          spinner.remove();
        }
        
        // Remove loading class to restore articles
        articlesContainer.classList.remove('loading-active');
      }
      
      function showNoResults() {
        // Remove existing no results message if any
        const existingMessage = articlesContainer.querySelector('.no-results-message');
        if (existingMessage) {
          existingMessage.remove();
        }
        
        // Create and append no results message
        const noResultsMessage = document.createElement('div');
        noResultsMessage.className = 'no-results-message';
        noResultsMessage.textContent = '{{ section.settings.no_results_text | escape }}';
        articlesContainer.appendChild(noResultsMessage);
      }
      
      function hideNoResults() {
        const noResultsMessage = articlesContainer.querySelector('.no-results-message');
        if (noResultsMessage) {
          noResultsMessage.remove();
        }
      }
      
      function checkAndShowNoResults(articlesHTML) {
        // Check if articles container is empty or has no article elements
        if (!articlesHTML || articlesHTML.trim() === '') {
          showNoResults();
          return true;
        }
        
        // Create a temporary container to check for article elements
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = articlesHTML;
        const hasArticles = tempDiv.querySelector('.blog-articles__article, .article, article') !== null;
        
        if (!hasArticles) {
          showNoResults();
          return true;
        }
        
        hideNoResults();
        return false;
      }
    
    
      // Handle browser back/forward buttons
      window.addEventListener('popstate', function(e) {
        const currentPath = window.location.pathname;
        const blogHandle = currentPath.split('/blogs/')[1] || currentPath.split('/').pop();
        
        if (blogHandle && blogHandle !== currentBlog) {
          currentBlog = blogHandle;
          currentPage = 1;
          currentSearchTerm = '';
          searchInput.value = '';
          
          // Update active navigation
          blogNavigation.forEach(nav => {
            nav.classList.remove('active');
            const navUrl = nav.getAttribute('data-blog-url');
            if (navUrl.includes(blogHandle) || navUrl.endsWith(blogHandle)) {
              nav.classList.add('active');
            }
          });
          
          loadBlogContent();
        }
      });
    
      // Cache management functions
      function getCacheStats() {
        return {
          blog: cache.blog.size,
          search: cache.search.size,
          total: cache.blog.size + cache.search.size
        };
      }
    
      function logCacheStats() {
        const stats = getCacheStats();
        return stats;
      }
    
      // Clear cache when switching blogs (optional - for fresh content)
      function clearBlogCache() {
        clearCache('blog');
      }
    
      // Clear cache when performing new search (optional - for fresh results)
      function clearSearchCache() {
        clearCache('search');
      }
    
      // Auto-clear cache every 10 minutes (optional)
      setInterval(() => {
        // The cache system automatically removes expired entries on access
        logCacheStats();
      }, 10 * 60 * 1000);
    
    
      // Initial pagination listeners
      attachPaginationListeners();
      
      // Check for no results on initial page load
      const initialArticlesHTML = articlesContainer.innerHTML;
      checkAndShowNoResults(initialArticlesHTML);
    });
    </script>