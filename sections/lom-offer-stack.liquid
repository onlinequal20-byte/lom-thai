{{ 'lom-natural.css' | asset_url | stylesheet_tag }}

{%- comment -%} Pull product for dynamic pricing — same logic as product page {%- endcomment -%}
{%- assign offer_product = all_products[section.settings.product_handle] -%}
{%- if offer_product != blank -%}
  {%- assign base_price = offer_product.price -%}
{%- else -%}
  {%- assign base_price = 2395 -%}
{%- endif -%}
{%- assign price_1 = base_price -%}
{%- assign price_3 = base_price | times: 3 | times: 80 | divided_by: 100 -%}
{%- assign price_5 = base_price | times: 5 | times: 70 | divided_by: 100 -%}
{%- assign compare_3 = base_price | times: 3 -%}
{%- assign compare_5 = base_price | times: 5 -%}
{%- assign unit_3 = price_3 | divided_by: 3 -%}
{%- assign unit_5 = price_5 | divided_by: 5 -%}

<section class="lom-offer-stack">
  <div class="lom-container">
    <h2 class="lom-heading lom-reveal">{{ section.settings.heading }}</h2>

    <div class="lom-offer-grid lom-reveal">
      {%- comment -%} Try It — 1 stick {%- endcomment -%}
      <div class="lom-offer-card">
        <h3 class="lom-offer-card__name">Try It — 1 Stick</h3>
        <p class="lom-offer-card__tagline">See what the hype is about</p>
        <div class="lom-offer-card__pricing">
          <span class="lom-offer-card__price">{{ price_1 | money }}</span>
        </div>
        <button type="button" class="lom-cta-btn lom-offer-card__cta lom-cta-btn--outline lom-offer-atc" data-quantity="1">
          Add to Cart — {{ price_1 | money }}
        </button>
      </div>

      {%- comment -%} Relief Pack — 3 sticks, 20% off {%- endcomment -%}
      <div class="lom-offer-card lom-offer-card--highlighted">
        <span class="lom-offer-card__badge lom-offer-card__badge--popular">Most Popular</span>
        <h3 class="lom-offer-card__name">Relief Pack — 3 Sticks</h3>
        <p class="lom-offer-card__tagline">One for home. One for work. One for the gym.</p>
        <div class="lom-offer-card__pricing">
          <span class="lom-offer-card__compare">{{ compare_3 | money }}</span>
          <span class="lom-offer-card__price">{{ price_3 | money }}</span>
          <span class="lom-offer-card__savings">Save 20%</span>
        </div>
        <span class="lom-offer-card__unit">{{ unit_3 | money }}/stick</span>
        <button type="button" class="lom-cta-btn lom-offer-card__cta lom-cta-btn--primary lom-offer-atc" data-quantity="3">
          Add to Cart — {{ price_3 | money }}
        </button>
      </div>

      {%- comment -%} Never Run Out — 5 sticks, 30% off {%- endcomment -%}
      <div class="lom-offer-card">
        <span class="lom-offer-card__badge lom-offer-card__badge--value">Best Value</span>
        <h3 class="lom-offer-card__name">Never Run Out — 5 Sticks</h3>
        <p class="lom-offer-card__tagline">Best price. Stock up for the year.</p>
        <div class="lom-offer-card__pricing">
          <span class="lom-offer-card__compare">{{ compare_5 | money }}</span>
          <span class="lom-offer-card__price">{{ price_5 | money }}</span>
          <span class="lom-offer-card__savings">Save 30%</span>
        </div>
        <span class="lom-offer-card__unit">{{ unit_5 | money }}/stick</span>
        <button type="button" class="lom-cta-btn lom-offer-card__cta lom-cta-btn--outline lom-offer-atc" data-quantity="5">
          Add to Cart — {{ price_5 | money }}
        </button>
      </div>
    </div>

    <p class="lom-offer-stack__reassurance lom-reveal">{{ section.settings.reassurance }}</p>
  </div>
</section>

<script>
  (function() {
    var variantId = null;
    var productHandle = '{{ section.settings.product_handle | default: "thai-herbal-nasal-inhaler" }}';
    var productReady = false;

    var productFetch = fetch('/products/' + productHandle + '.js')
      .then(function(r) { return r.json(); })
      .then(function(product) {
        if (product.variants && product.variants.length > 0) {
          variantId = product.variants[0].id;
          productReady = true;
        }
      })
      .catch(function() {});

    document.querySelectorAll('.lom-offer-stack .lom-offer-atc').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var qty = parseInt(btn.getAttribute('data-quantity')) || 1;
        var originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Adding...';

        function addToCart() {
          fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: variantId, quantity: qty })
          })
          .then(function(r) {
            if (!r.ok) throw new Error('Add to cart failed');
            return r.json();
          })
          .then(function() {
            btn.textContent = 'Added ✓';
            var drawerEl = document.querySelector('cart-drawer');
            if (drawerEl) {
              fetch('/cart?sections=cart-drawer,cart-icon-bubble')
                .then(function(r) { return r.json(); })
                .then(function(sections) {
                  // Replace full cart-drawer HTML to keep #CartDrawer and all inner elements intact
                  if (sections['cart-drawer']) {
                    var parsed = new DOMParser().parseFromString(sections['cart-drawer'], 'text/html');
                    var newDrawer = parsed.querySelector('cart-drawer');
                    if (newDrawer) {
                      drawerEl.innerHTML = newDrawer.innerHTML;
                      drawerEl.classList.remove('is-empty');
                    }
                  }
                  // Update cart icon bubble count
                  if (sections['cart-icon-bubble']) {
                    var bubbleParsed = new DOMParser().parseFromString(sections['cart-icon-bubble'], 'text/html');
                    var newBubble = bubbleParsed.querySelector('.shopify-section');
                    var oldBubble = document.getElementById('cart-icon-bubble');
                    if (newBubble && oldBubble) oldBubble.innerHTML = newBubble.innerHTML;
                  }
                  // Re-bind overlay close event
                  var overlay = drawerEl.querySelector('#CartDrawer-Overlay');
                  if (overlay) overlay.addEventListener('click', function() { drawerEl.close(); });
                  // Open using Dawn's method
                  drawerEl.open(btn);
                })
                .catch(function() { window.location = '/cart'; });
            } else {
              window.location = '/cart';
            }
            setTimeout(function() {
              btn.disabled = false;
              btn.textContent = originalText;
            }, 2000);
          })
          .catch(function() {
            btn.disabled = false;
            btn.textContent = originalText;
          });
        }

        // Wait for product data before adding to cart
        if (productReady) {
          addToCart();
        } else {
          productFetch.then(addToCart);
        }
      });
    });

    // Reveal animation
    var els = document.querySelectorAll('.lom-offer-stack .lom-reveal');
    if (els.length) {
      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.15 });
      els.forEach(function(el) { observer.observe(el); });
    }
  })();
</script>

{% schema %}
{
  "name": "Lom Offer Stack",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Choose How You Want to Feel"
    },
    {
      "type": "text",
      "id": "product_handle",
      "label": "Product handle (URL slug)",
      "default": "thai-herbal-nasal-inhaler",
      "info": "Used to fetch the product price. Prices auto-calculate: 1x = full price, 3x = 20% off, 5x = 30% off."
    },
    {
      "type": "textarea",
      "id": "reassurance",
      "label": "Reassurance Text",
      "default": "Every order ships free to the US. Every order is backed by our 30-day guarantee."
    }
  ],
  "presets": [
    {
      "name": "Lom Offer Stack"
    }
  ]
}
{% endschema %}
