{{ 'lom-natural.css' | asset_url | stylesheet_tag }}

<section class="lom-offer-stack">
  <div class="lom-container">
    <h2 class="lom-heading lom-reveal">{{ section.settings.heading }}</h2>

    <div class="lom-offer-grid lom-reveal">
      {%- for block in section.blocks -%}
        <div class="lom-offer-card{% if block.settings.highlighted %} lom-offer-card--highlighted{% endif %}" {{ block.shopify_attributes }}>
          {%- if block.settings.badge != blank -%}
            <span class="lom-offer-card__badge{% if block.settings.highlighted %} lom-offer-card__badge--popular{% endif %}">{{ block.settings.badge }}</span>
          {%- endif -%}
          <h3 class="lom-offer-card__name">{{ block.settings.name }}</h3>
          <p class="lom-offer-card__tagline">{{ block.settings.tagline }}</p>
          <div class="lom-offer-card__pricing">
            {%- if block.settings.compare_price != blank -%}
              <span class="lom-offer-card__compare">{{ block.settings.compare_price }}</span>
            {%- endif -%}
            <span class="lom-offer-card__price">{{ block.settings.price }}</span>
            {%- if block.settings.savings != blank -%}
              <span class="lom-offer-card__savings">{{ block.settings.savings }}</span>
            {%- endif -%}
          </div>
          <button
            type="button"
            class="lom-cta-btn lom-offer-card__cta{% if block.settings.highlighted %} lom-cta-btn--primary{% else %} lom-cta-btn--outline{% endif %} lom-offer-atc"
            data-quantity="{{ block.settings.quantity | default: 1 }}"
          >
            {{ block.settings.cta_text | default: 'Add to Cart' }}
          </button>
          <noscript>
            <a href="{{ block.settings.url | default: '/collections/all' }}" class="lom-cta-btn lom-offer-card__cta{% if block.settings.highlighted %} lom-cta-btn--primary{% else %} lom-cta-btn--outline{% endif %}">
              {{ block.settings.cta_text | default: 'Add to Cart' }}
            </a>
          </noscript>
        </div>
      {%- endfor -%}
    </div>

    <p class="lom-offer-stack__reassurance lom-reveal">{{ section.settings.reassurance }}</p>
  </div>
</section>

<script>
  (function() {
    var variantId = null;
    var productHandle = 'lom-thai-authentic-muay-thai-oil';

    fetch('/products/' + productHandle + '.js')
      .then(function(r) { return r.json(); })
      .then(function(product) {
        if (product.variants && product.variants.length > 0) {
          variantId = product.variants[0].id;
        }
      })
      .catch(function() {});

    document.querySelectorAll('.lom-offer-stack .lom-offer-atc').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (!variantId) {
          window.location = '/products/' + productHandle;
          return;
        }

        var qty = parseInt(btn.getAttribute('data-quantity')) || 1;
        var originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Adding...';

        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: variantId, quantity: qty })
        })
        .then(function(r) {
          if (!r.ok) throw new Error('Add to cart failed');
          return r.json();
        })
        .then(function() {
          btn.textContent = 'Added âœ“';
          var drawer = document.querySelector('cart-drawer');
          if (drawer && typeof drawer.open === 'function') {
            drawer.open();
          } else {
            // Try Dawn's cart drawer approach
            var drawerEl = document.querySelector('cart-drawer');
            if (drawerEl) {
              drawerEl.classList.add('is-empty');
              drawerEl.classList.remove('is-empty');
              // Trigger section rendering refresh
              fetch('/cart?sections=cart-drawer')
                .then(function(r) { return r.json(); })
                .then(function(sections) {
                  if (drawerEl.querySelector('.drawer__inner')) {
                    drawerEl.querySelector('.drawer__inner').innerHTML =
                      new DOMParser().parseFromString(sections['cart-drawer'], 'text/html')
                        .querySelector('.drawer__inner').innerHTML;
                  }
                  drawerEl.open ? drawerEl.open() : (drawerEl.style.display = '');
                  drawerEl.setAttribute('open', '');
                })
                .catch(function() {
                  window.location = '/cart';
                });
            } else {
              window.location = '/cart';
            }
          }
          setTimeout(function() {
            btn.disabled = false;
            btn.textContent = originalText;
          }, 2000);
        })
        .catch(function() {
          btn.disabled = false;
          btn.textContent = originalText;
        });
      });
    });

    // Reveal animation
    var els = document.querySelectorAll('.lom-offer-stack .lom-reveal');
    if (els.length) {
      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.15 });
      els.forEach(function(el) { observer.observe(el); });
    }
  })();
</script>

{% schema %}
{
  "name": "Lom Offer Stack",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Choose How You Want to Feel"
    },
    {
      "type": "textarea",
      "id": "reassurance",
      "label": "Reassurance Text",
      "default": "Every order ships free to the US. Every order is backed by our 30-day guarantee."
    }
  ],
  "blocks": [
    {
      "type": "offer",
      "name": "Offer Card",
      "settings": [
        {
          "type": "text",
          "id": "name",
          "label": "Offer Name",
          "default": "Try It"
        },
        {
          "type": "text",
          "id": "tagline",
          "label": "Tagline",
          "default": "See what the hype is about"
        },
        {
          "type": "text",
          "id": "price",
          "label": "Price",
          "default": "$8"
        },
        {
          "type": "text",
          "id": "compare_price",
          "label": "Compare Price (strikethrough)"
        },
        {
          "type": "text",
          "id": "savings",
          "label": "Savings Text"
        },
        {
          "type": "text",
          "id": "badge",
          "label": "Badge Text"
        },
        {
          "type": "checkbox",
          "id": "highlighted",
          "label": "Highlight this card",
          "default": false
        },
        {
          "type": "text",
          "id": "cta_text",
          "label": "Button Text",
          "default": "Add to Cart"
        },
        {
          "type": "range",
          "id": "quantity",
          "label": "Quantity to add",
          "min": 1,
          "max": 10,
          "step": 1,
          "default": 1
        },
        {
          "type": "url",
          "id": "url",
          "label": "Fallback Link (noscript)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Lom Offer Stack",
      "blocks": [
        {
          "type": "offer",
          "settings": {
            "name": "Try It",
            "tagline": "See what the hype is about",
            "price": "$8",
            "highlighted": false,
            "cta_text": "Add to Cart",
            "quantity": 1
          }
        },
        {
          "type": "offer",
          "settings": {
            "name": "Relief Pack",
            "tagline": "One for home. One for work. One for the gym.",
            "price": "$19.20",
            "compare_price": "$24",
            "savings": "Save 20%",
            "badge": "Most Popular",
            "highlighted": true,
            "cta_text": "Add to Cart",
            "quantity": 3
          }
        },
        {
          "type": "offer",
          "settings": {
            "name": "Never Run Out",
            "tagline": "Best price. Stock up for the year.",
            "price": "$28",
            "compare_price": "$40",
            "savings": "Save 30%",
            "badge": "Best Value",
            "highlighted": false,
            "cta_text": "Add to Cart",
            "quantity": 5
          }
        }
      ]
    }
  ]
}
{% endschema %}
